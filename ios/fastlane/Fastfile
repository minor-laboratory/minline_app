# iOS Fastlane Configuration for MiniLine App

require 'dotenv'

default_platform(:ios)

platform :ios do
  desc "App Store Connectì— ì•± ìƒì„± (ìµœì´ˆ 1íšŒë§Œ, App-specific password í•„ìš”)"
  lane :create_app do
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_env_file

    puts "âš ï¸  ì´ ëª…ë ¹ì€ Apple IDì™€ App-specific passwordê°€ í•„ìš”í•©ë‹ˆë‹¤."
    puts "App-specific password ìƒì„±: https://appleid.apple.com"
    puts ""

    # ì•± ìƒì„± (produceëŠ” API í‚¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ)
    produce(
      username: ENV['APPLE_ID'],
      app_identifier: ENV['DEVELOPER_APP_IDENTIFIER'],
      app_name: "MiniLine",
      language: "ko",
      app_version: "1.0",
      sku: ENV['DEVELOPER_APP_IDENTIFIER'],
      team_id: ENV['DEVELOPER_PORTAL_TEAM_ID']
    )

    puts "âœ… App Store Connectì— ì•±ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
    puts "App Store Connectì—ì„œ ì•± IDë¥¼ í™•ì¸í•˜ì—¬ ios/.envì˜ DEVELOPER_APP_IDë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”."
  end

  desc "MiniLine iOS ì•± TestFlight ë°°í¬ (ì™„ì „ ìë™í™”: flutter clean â†’ build_runner â†’ icon/splash â†’ build â†’ upload)"
  lane :beta do
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_env_file

    # ë¹Œë“œ ë²ˆí˜¸ ì„¤ì • (pubspec.yamlê³¼ ë™ê¸°í™”)
    increment_build_number(
      xcodeproj: "Runner.xcodeproj",
      build_number: "1"
    )

    # 1ë‹¨ê³„: Flutter ë¹Œë“œ ìºì‹œ ì •ë¦¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜
    puts "ğŸ§¹ [1/7] Flutter ë¹Œë“œ ìºì‹œ ì •ë¦¬ ë° ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
    sh("cd ../.. && flutter clean && flutter pub get")

    # 2ë‹¨ê³„: ì½”ë“œ ìƒì„± (build_runner)
    puts "ğŸ”¨ [2/7] ì½”ë“œ ìƒì„± (build_runner) ì¤‘..."
    sh("cd ../.. && dart run build_runner build --delete-conflicting-outputs")

    # 3ë‹¨ê³„: ì•„ì´ì½˜ ìƒì„±
    puts "ğŸ¨ [3/7] ì•± ì•„ì´ì½˜ ìƒì„± ì¤‘..."
    sh("cd ../.. && dart run flutter_launcher_icons")

    # 4ë‹¨ê³„: ìŠ¤í”Œë˜ì‹œ í™”ë©´ ìƒì„±
    puts "ğŸ–¼ï¸ [4/7] ìŠ¤í”Œë˜ì‹œ í™”ë©´ ìƒì„± ì¤‘..."
    sh("cd ../.. && dart run flutter_native_splash:create")

    # 5ë‹¨ê³„: CocoaPods ì„¤ì¹˜
    puts "ğŸ“¦ [5/7] CocoaPods ì„¤ì¹˜ ì¤‘..."
    sh("cd .. && pod install")

    # 6ë‹¨ê³„: Flutter iOS ë¹Œë“œ (storyboard ì»´íŒŒì¼ ë¬¸ì œ ë°©ì§€)
    puts "ğŸ—ï¸ [6/7] Flutter iOS ë¹Œë“œ (release, no-codesign) ì¤‘..."
    sh("cd ../.. && flutter build ios --release --no-codesign")

    # 7ë‹¨ê³„: Xcode Archive & IPA Export (gym ì‚¬ìš©)
    puts "ğŸ“¦ [7/7] Xcode Archive & IPA ìƒì„± ì¤‘..."

    # ë¹Œë“œ ë””ë ‰í† ë¦¬ ì •ë¦¬
    project_root = File.expand_path('../..', __dir__)
    ipa_output_dir = File.join(project_root, 'build/ios/ipa')
    sh("rm -rf #{ipa_output_dir}")
    sh("mkdir -p #{ipa_output_dir}")

    # gymìœ¼ë¡œ Archive & Export (ìë™ ì„œëª… ì‚¬ìš©)
    gym(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      configuration: "Release",
      export_method: "app-store",
      output_directory: ipa_output_dir,
      output_name: "MiniLine.ipa",
      export_options: {
        method: "app-store",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        teamID: ENV['DEVELOPER_PORTAL_TEAM_ID'],
        signingStyle: "automatic",
        iCloudContainerEnvironment: "Production"
      },
      xcargs: "-allowProvisioningUpdates"
    )

    # IPA íŒŒì¼ ê²½ë¡œ
    ipa_path = File.join(ipa_output_dir, 'MiniLine.ipa')

    puts "IPA íŒŒì¼ ê²½ë¡œ: #{ipa_path}"

    # App Store Connect API í‚¤ ì„¤ì • (íŒŒì¼ ë‚´ìš© ì§ì ‘ ì½ê¸°)
    key_content = File.read(ENV['APP_STORE_CONNECT_API_KEY_PATH'])

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: key_content,
      duration: 1200,
      in_house: false
    )

    # TestFlight ì—…ë¡œë“œ
    puts "ğŸš€ TestFlight ì—…ë¡œë“œ ì¤‘..."
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      changelog: "ìƒˆë¡œìš´ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ë° ë²„ê·¸ ìˆ˜ì •"
    )

    puts "âœ… TestFlight ë°°í¬ ì™„ë£Œ!"
  end

  desc "IPA íŒŒì¼ë§Œ TestFlightì— ì—…ë¡œë“œ (ë¹Œë“œ ì œì™¸)"
  lane :upload_only do
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_env_file

    # IPA íŒŒì¼ ê²½ë¡œ (ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©)
    project_root = File.expand_path('../..', __dir__)
    ipa_path = File.join(project_root, 'build/ios/ipa/MiniLine.ipa')

    unless File.exist?(ipa_path)
      UI.user_error!("IPA íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: #{ipa_path}")
    end

    puts "IPA íŒŒì¼ ê²½ë¡œ: #{ipa_path}"

    # App Store Connect API í‚¤ ì„¤ì •
    key_content = File.read(ENV['APP_STORE_CONNECT_API_KEY_PATH'])

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: key_content,
      duration: 1200,
      in_house: false
    )

    # TestFlight ì—…ë¡œë“œ
    puts "ğŸš€ TestFlight ì—…ë¡œë“œ ì¤‘..."
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      changelog: "ìƒˆë¡œìš´ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ë° ë²„ê·¸ ìˆ˜ì •"
    )

    puts "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"
  end

  desc "MiniLine iOS ì•± App Store ë°°í¬"
  lane :deploy do
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_env_file

    # ë¹Œë“œ ë²ˆí˜¸ ìë™ ì¦ê°€
    increment_build_number(xcodeproj: "Runner.xcodeproj")

    # ì•± ë¹Œë“œ (ìë™ ì„œëª… ì‚¬ìš©)
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios",
      xcargs: "-allowProvisioningUpdates"
    )

    # App Store ì—…ë¡œë“œ
    upload_to_app_store(
      force: true,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: false
    )
  end

  desc "API í‚¤ í…ŒìŠ¤íŠ¸"
  lane :test_api_key do
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_env_file

    # App Store Connect API í‚¤ ì„¤ì • í…ŒìŠ¤íŠ¸
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_filepath: ENV['APP_STORE_CONNECT_API_KEY_PATH'],
      duration: 1200,
      in_house: false
    )

    puts "âœ… API í‚¤ ìƒì„± ì„±ê³µ: #{api_key}"
  end

  desc "ë©”íƒ€ë°ì´í„°ë§Œ ì—…ë¡œë“œ (ì•± ì •ë³´, ìŠ¤í¬ë¦°ìƒ·)"
  lane :metadata do
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_env_file

    # DELIVER_FORCE_OVERWRITE ì„¤ì • (ê³µì‹ ë¬¸ì„œ ê¶Œì¥ í•´ê²°ì±…)
    ENV["DELIVER_FORCE_OVERWRITE"] = "1"

    # App Store Connect API í‚¤ ì„¤ì • - ì§ì ‘ í‚¤ ì½˜í…ì¸  ì½ê¸° ë°©ì‹
    key_content = File.read(ENV['APP_STORE_CONNECT_API_KEY_PATH'])

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: key_content,
      duration: 1200,
      in_house: false
    )

    deliver(
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      edit_live: false,
      use_live_version: false,
      metadata_path: "./fastlane/metadata",
      api_key: api_key,
      app_identifier: ENV['DEVELOPER_APP_IDENTIFIER'],
      skip_app_version_update: false,
      app_version: "1.0",
      run_precheck_before_submit: false
    )
  end

  desc "ìŠ¤í¬ë¦°ìƒ·ë§Œ ì—…ë¡œë“œ"
  lane :screenshots do
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_env_file

    # App Store Connect API í‚¤ ì„¤ì •
    key_content = File.read(ENV['APP_STORE_CONNECT_API_KEY_PATH'])

    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_content: key_content,
      duration: 1200,
      in_house: false
    )

    deliver(
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      force: true,
      api_key: api_key,
      app_identifier: ENV['DEVELOPER_APP_IDENTIFIER'],
      run_precheck_before_submit: false,
      screenshots_path: "./fastlane/screenshots"
    )
  end

  private_lane :load_env_file do
    # .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    env_file_path = File.expand_path('../.env', __dir__)
    if File.exist?(env_file_path)
      Dotenv.load(env_file_path)
      puts "âœ… í™˜ê²½ ë³€ìˆ˜ ë¡œë“œë¨: #{env_file_path}"
      puts "Key ID: #{ENV['APP_STORE_CONNECT_API_KEY_ID']}"
      puts "Issuer ID: #{ENV['APP_STORE_CONNECT_API_ISSUER_ID']}"
      puts "ëª¨ë“  APP_STORE_CONNECT í™˜ê²½ ë³€ìˆ˜:"
      ENV.each do |key, value|
        if key.start_with?('APP_STORE_CONNECT')
          puts "  #{key} = #{value}"
        end
      end
    else
      puts "âŒ .env íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: #{env_file_path}"
    end
  end
end
